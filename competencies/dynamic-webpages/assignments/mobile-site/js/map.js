var historicalOverlay;
var map;
var infoWindow;
var floors = [];
var currFloor = 1;

var searchRoom;
var searchFloor;
var searchRoomMarker;

//var roomNames = ['054', '080', '052A', '034', '051', '051A', '025', '023', '021', '015', '013', '011', '026', '024', '022', '016', '014', '012', '010',161,163,165,167,162,164, 125, 120, 115, 105,100,278,274,272,268,266,258,298,296,294,288,291,289,287,285,283,281,279,277,275,273,271,269,267,265,263,261,259,257,255,253,251,299,297,295,293,231,231,229,227,225,223,221,219,217,215,213,211,209,207,205,203,202,210,'210A',216,220,'220A',222,224,226,382,386,368,352,390,350,383,381,379,377,375,373,371,369,367,365,363,361,359,357,355,353,351,385,'385A',315,311,309,307,305,303,302,304,310,312,314,316,452,462,498,'498A',494,499,497,495,'495A',493,491,489,487,480,485,483,481,479,477,475,473,471,469,467,465,463,461,459,457,455,419,411,413,409,407,405,420,418,416,414,412,408,406,404]
//var rmIndex = 0;
var rooms = {"floor0":{"054":{"lat":48.73236566559072,"lng":-122.48543151477952},"080":{"lat":48.732395740687444,"lng":-122.48555221418519},"052A":{"lat":48.732359473656814,"lng":-122.48510696748872},"034":{"lat":48.73247712027076,"lng":-122.4851042852797},"051":{"lat":48.73248508130989,"lng":-122.48526924113412},"051A":{"lat":48.73250365706293,"lng":-122.4854087160029},"025":{"lat":48.73269934721195,"lng":-122.48528139595504},"023":{"lat":48.73278514907682,"lng":-122.48529748920913},"021":{"lat":48.73285945160436,"lng":-122.48530151252265},"015":{"lat":48.732936407677826,"lng":-122.48529346589561},"013":{"lat":48.733008940880644,"lng":-122.48529748920913},"011":{"lat":48.73308589672531,"lng":-122.48529748920913},"026":{"lat":48.73270996188357,"lng":-122.4851298511457},"024":{"lat":48.73277718808519,"lng":-122.4851298511457},"022":{"lat":48.73283822232199,"lng":-122.48513521556373},"016":{"lat":48.732925793054015,"lng":-122.48513119225021},"014":{"lat":48.73298417345732,"lng":-122.48513655666824},"012":{"lat":48.73305936024047,"lng":-122.48513253335472},"010":{"lat":48.733145161490945,"lng":-122.48513387445922}},"floor1":{"100":{"lat":48.7331522378762,"lng":-122.48512370770987},"105":{"lat":48.73309385766806,"lng":-122.48515991753158},"110":{'lat': 48.7329989001259, 'lng': -122.48515830734027},"115":{"lat":48.73287714266617,"lng":-122.48515455311355},"120":{"lat":48.732767457982625,"lng":-122.48515991753158},"125":{"lat":48.732671041409986,"lng":-122.48515589421805},"161":{"lat":48.73237559865072,"lng":-122.48511912230964},"162":{"lat":48.732490591547794,"lng":-122.48532565240379},"163":{"lat":48.732372060403556,"lng":-122.48519958858009},"164":{"lat":48.73248705330875,"lng":-122.4854369640779},"165":{"lat":48.73237648321246,"lng":-122.48531760577674},"167":{"lat":48.73237559865072,"lng":-122.48542757634635}},"floor2":{"202":{"lat":48.7330864754926,"lng":-122.48529277885228},"203":{"lat":48.7331501629984,"lng":-122.48511172974378},"205":{"lat":48.73311831925557,"lng":-122.48517342055112},"207":{"lat":48.73310770467018,"lng":-122.48511038863927},"209":{"lat":48.733067899954904,"lng":-122.48510368311673},"210":{"lat":48.73303251795931,"lng":-122.4852766855982},"211":{"lat":48.73305286260982,"lng":-122.48517476165563},"213":{"lat":48.733031633409084,"lng":-122.48510636532575},"215":{"lat":48.733025441557196,"lng":-122.4851881727007},"216":{"lat":48.73297767581695,"lng":-122.4852954610613},"217":{"lat":48.73298740587882,"lng":-122.48510636532575},"219":{"lat":48.732982983123655,"lng":-122.48517744386464},"220":{"lat":48.73291664174945,"lng":-122.48527132118016},"221":{"lat":48.73294317830963,"lng":-122.48512916410237},"222":{"lat":48.73286445314024,"lng":-122.48529277885228},"223":{"lat":48.732902488911634,"lng":-122.48513184631139},"224":{"lat":48.73280076527252,"lng":-122.48530082547933},"225":{"lat":48.73285472305454,"lng":-122.48512916410237},"226":{"lat":48.732740615545644,"lng":-122.48529411995679},"227":{"lat":48.732789266065595,"lng":-122.48512782299787},"229":{"lat":48.73273707732415,"lng":-122.48512916410237},"231":{"lat":48.73273707732415,"lng":-122.48513050520688},"251":{"lat":48.73251063063211,"lng":-122.48516805613309},"253":{"lat":48.73250266959706,"lng":-122.48508356654912},"255":{"lat":48.73247347912431,"lng":-122.48507417881757},"257":{"lat":48.73245048055811,"lng":-122.48507417881757},"258":{"lat":48.73243632758908,"lng":-122.48516269171506},"259":{"lat":48.73242305917695,"lng":-122.48507417881757},"261":{"lat":48.73239563778086,"lng":-122.48507283771306},"263":{"lat":48.73236910093167,"lng":-122.48507149660855},"265":{"lat":48.73233991038143,"lng":-122.48507417881757},"266":{"lat":48.73241067532253,"lng":-122.48515464508802},"267":{"lat":48.73235317881545,"lng":-122.485151962879},"268":{"lat":48.73241332900586,"lng":-122.4852056070593},"269":{"lat":48.73235317881545,"lng":-122.48519621932775},"271":{"lat":48.732354063377606,"lng":-122.48523779356748},"272":{"lat":48.73241332900586,"lng":-122.48526595676213},"273":{"lat":48.732354063377606,"lng":-122.48528339112073},"274":{"lat":48.73241421356694,"lng":-122.48533032977849},"275":{"lat":48.732354063377606,"lng":-122.48532228315145},"277":{"lat":48.7323522942533,"lng":-122.48536385739118},"278":{"lat":48.73241332900586,"lng":-122.48539202058583},"279":{"lat":48.73235317881545,"lng":-122.4854027494219},"281":{"lat":48.73235140969112,"lng":-122.48544566476613},"283":{"lat":48.732359370750146,"lng":-122.48548992121488},"285":{"lat":48.732420405494125,"lng":-122.48553283655912},"287":{"lat":48.73244517319519,"lng":-122.48551406109601},"288":{"lat":48.732457557041144,"lng":-122.48539738500386},"289":{"lat":48.73247082544413,"lng":-122.48550601446897},"291":{"lat":48.73249559312036,"lng":-122.48548723900586},"293":{"lat":48.732512399750846,"lng":-122.48542823040754},"294":{"lat":48.732456672480815,"lng":-122.48533569419652},"295":{"lat":48.73250620783501,"lng":-122.48536922180921},"296":{"lat":48.73245578792048,"lng":-122.48529009664327},"297":{"lat":48.73250443871607,"lng":-122.48529411995679},"298":{"lat":48.732458441601466,"lng":-122.48522840583593},"299":{"lat":48.73250266959706,"lng":-122.48525254571706},"210A":{"lat":48.733025441557196,"lng":-122.48534508192807},"220A":{"lat":48.73291398809266,"lng":-122.48533032977849}},"floor3":{"302":{"lat":48.73306381574662,"lng":-122.48530198202423},"303":{"lat":48.73312927237812,"lng":-122.48516250715545},"304":{"lat":48.73298243711292,"lng":-122.48529259429267},"305":{"lat":48.733060277547885,"lng":-122.48510349855712},"307":{"lat":48.73299393627568,"lng":-122.48512629733375},"309":{"lat":48.73293555588371,"lng":-122.48513702616981},"310":{"lat":48.732905481109896,"lng":-122.48529929981521},"311":{"lat":48.73288425184693,"lng":-122.48512227402023},"312":{"lat":48.73282410221992,"lng":-122.48529929981521},"314":{"lat":48.732757760636076,"lng":-122.48529393539718},"315":{"lat":48.732757760636076,"lng":-122.48513032064727},"316":{"lat":48.73267726606347,"lng":-122.4852966176062},"350":{"lat":48.73245183837062,"lng":-122.48535178745061},"351":{"lat":48.732499604610474,"lng":-122.48517610276014},"352":{"lat":48.732431493476916,"lng":-122.48517476165563},"353":{"lat":48.73250137372959,"lng":-122.4850808843401},"355":{"lat":48.73244564644733,"lng":-122.48507686102658},"357":{"lat":48.73242441699022,"lng":-122.48507686102658},"359":{"lat":48.732396111033474,"lng":-122.48507820213109},"361":{"lat":48.73236692049887,"lng":-122.4850808843401},"363":{"lat":48.73233949907216,"lng":-122.48508222544461},"365":{"lat":48.7323430373216,"lng":-122.48516135061055},"367":{"lat":48.73234215275926,"lng":-122.48519756043225},"368":{"lat":48.7324120331361,"lng":-122.48526595676213},"369":{"lat":48.7323430373216,"lng":-122.485241816881},"371":{"lat":48.7323430373216,"lng":-122.48528741443425},"373":{"lat":48.7323430373216,"lng":-122.48532228315145},"375":{"lat":48.73234215275926,"lng":-122.48537190401822},"377":{"lat":48.732346575570816,"lng":-122.48541616046697},"379":{"lat":48.73234480644623,"lng":-122.48544834697515},"381":{"lat":48.73234746013307,"lng":-122.4854939445284},"382":{"lat":48.73240849489151,"lng":-122.48543359482557},"383":{"lat":48.732462453094534,"lng":-122.48550735557347},"385":{"lat":48.73250314284866,"lng":-122.48531825983792},"386":{"lat":48.7324138022583,"lng":-122.48535446965963},"390":{"lat":48.732455376612165,"lng":-122.48526729786664},"385A":{"lat":48.732504911967645,"lng":-122.48542957151204}},"floor4":{"404":{"lat":48.73309742862209,"lng":-122.48530064091972},"405":{"lat":48.733038163800224,"lng":-122.48512361512473},"406":{"lat":48.7330461247505,"lng":-122.48529929981521},"407":{"lat":48.73295855422805,"lng":-122.48516653046897},"408":{"lat":48.73298774441915,"lng":-122.48529393539718},"409":{"lat":48.73295236236715,"lng":-122.48510215745262},"411":{"lat":48.73287717542397,"lng":-122.4850981341391},"412":{"lat":48.73293997864305,"lng":-122.48529393539718},"413":{"lat":48.732881598188435,"lng":-122.48516921267799},"414":{"lat":48.732888674610805,"lng":-122.48529527650169},"416":{"lat":48.73282321766606,"lng":-122.4852979587107},"418":{"lat":48.73276660618565,"lng":-122.48530064091972},"419":{"lat":48.73250477725963,"lng":-122.48526443109802},"420":{"lat":48.73268080428914,"lng":-122.48530064091972},"452":{"lat":48.73245258822288,"lng":-122.48517725930503},"455":{"lat":48.732503892700144,"lng":-122.48512629733375},"457":{"lat":48.732493277985014,"lng":-122.48508874640754},"459":{"lat":48.73245347278327,"lng":-122.4850806997805},"461":{"lat":48.732424282282004,"lng":-122.485082040885},"462":{"lat":48.732412782988966,"lng":-122.48517591820053},"463":{"lat":48.7323933226409,"lng":-122.48508472309402},"465":{"lat":48.7323667857905,"lng":-122.485082040885},"467":{"lat":48.73233936436369,"lng":-122.48508472309402},"469":{"lat":48.73235528648431,"lng":-122.48515714273742},"471":{"lat":48.73235617104641,"lng":-122.48520005808166},"473":{"lat":48.73235528648431,"lng":-122.48523895011238},"475":{"lat":48.73235617104641,"lng":-122.48528320656112},"477":{"lat":48.73235705560852,"lng":-122.48532478080085},"479":{"lat":48.73235440192219,"lng":-122.48536635504058},"480":{"lat":48.7323526327979,"lng":-122.48553533420852},"481":{"lat":48.73235440192219,"lng":-122.4854052470713},"483":{"lat":48.73235351736005,"lng":-122.48543475137046},"485":{"lat":48.73235528648431,"lng":-122.48549375996879},"487":{"lat":48.73241720579429,"lng":-122.48554069862655},"489":{"lat":48.73243666613309,"lng":-122.48551521764091},"491":{"lat":48.73246674118736,"lng":-122.48550851211837},"493":{"lat":48.732506546378566,"lng":-122.48547900781921},"494":{"lat":48.732430474207916,"lng":-122.4854065881758},"495":{"lat":48.73250035446201,"lng":-122.48536501393608},"497":{"lat":48.73250035446201,"lng":-122.48530064091972},"498":{"lat":48.73243224332948,"lng":-122.48525906667999},"499":{"lat":48.732498585342846,"lng":-122.485261748889},"498A":{"lat":48.732430474207916,"lng":-122.48531271086028},"495A":{"lat":48.732505661819104,"lng":-122.48542938695243}}}


function initMap() {
    map = new google.maps.Map(document.getElementById('map'), {
        zoom: 19,
        center: { lat: 48.7327201, lng: -122.4852951 },
        zoomControl: true,
        mapTypeControl: false,
        scaleControl: true,
        streetViewControl: false,
        rotateControl: true,
        fullscreenControl: false,
        
    });
    
    var myoverlay = new google.maps.OverlayView();
    myoverlay.draw = function () {
        this.getPanes().markerLayer.id='markerLayer';
    };
    myoverlay.setMap(map);
    
    infoWindow = new google.maps.Marker;
    
    
    //Set up the image overlays
    var imageBounds = {
        north: 48.733207,
        south: 48.732324,
        east: -122.485051,
        west: -122.485634
    };
    
    for (var i = 0; i < 5; i++) {
        var thisfloor = new google.maps.GroundOverlay("assignments/mobile-site/img/CF-" + i + ".png", imageBounds)
        thisfloor.addListener('click', function (d) {
            console.log(d.latLng.lat());
            console.log(d.latLng.lng());
        })
        floors.push(thisfloor);
        
    }
    
    
    map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(setControls(downFloor, "assignments/mobile-site/img/downstairs.png","down"));
    map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(setControls(upFloor, "assignments/mobile-site/img/upstairs.png","up"));
    
    floors[currFloor].setMap(map);
}

function setControls(callbackFnc, img, name, spacing) {
    var width = '36';
    var height = '36';
    var buttonDiv = document.createElement('div');
    var controlUI = document.createElement('div');
    controlUI.setAttribute("id",name);
    controlUI.setAttribute("class", "floorBtn");
    
    buttonDiv.appendChild(controlUI);
    
    var controlImg = document.createElement('img');
    controlImg.setAttribute("src", img);
    controlUI.appendChild(controlImg);
    
    controlUI.addEventListener('click', callbackFnc);
    
    return buttonDiv;
}

function upFloor() {
    if (currFloor < 4) {
        floors[currFloor].setMap(null);
        floors[++currFloor].setMap(map);
        highlightRoom();
    }
}

function downFloor() {
    if (currFloor > 0) {
        floors[currFloor].setMap(null);
        floors[--currFloor].setMap(map);
        highlightRoom();
    }
}


function download(content, fileName, contentType) {
    var a = document.createElement("a");
    var file = new Blob([content], {type: contentType});
    a.href = URL.createObjectURL(file);
    a.download = fileName;
    a.click();
}

function searchFunc(){
    var OrigRoom = document.getElementById("searchText").value;
    var Room = OrigRoom.trim();
    Room = Room.toLowerCase();
    Room=Room.replace(" ","");
    if(Room.length>3) Room=Room.split("f")[1];
    if(Room != undefined && Room.length==3){
        var floorNum = Room[0];
        var floor = "floor"+Room[0];
        if(rooms[floor] == undefined || rooms[floor][Room] == undefined){
            alert("Room CF "+OrigRoom+" Not Found");
            console.log(Room);
            console.log(floor);
        }else{
            searchFloor = floorNum;
            searchRoom = rooms[floor][Room] ;
            highlightRoom();
        }
    }else{
        alert("Room CF "+OrigRoom+" Not Found");
        console.log(Room);
            console.log(floor);
    }
}

function highlightRoom(){
    if(parseInt(searchFloor) > currFloor){
        $("#up").attr("effect","flash");
        $("#down").attr("effect","none");
        hideOverlay();
    }else if(parseInt(searchFloor) <currFloor){
        $("#down").attr("effect","flash");
        $("#up").attr("effect","none");
        hideOverlay();
    }else{
        $("#down").attr("effect","none");
        $("#up").attr("effect","none");
        createOverlay();
        
    }
}

function createOverlay(){
    if(searchRoomMarker == undefined && searchRoom != undefined){
        var latLng = new google.maps.LatLng(searchRoom.lat, searchRoom.lng);
        
        var image = new google.maps.MarkerImage(
            "assignments/mobile-site/img/activeRoom.png",
            null, // size
            null, // origin
            new google.maps.Point( 15, 15 ), // anchor (move to center of marker)
            new google.maps.Size( 30, 30 ) // scaled size (required for Retina display icon)
            );
            searchRoomMarker = new google.maps.Marker({
                flat: true,
                icon: image,
                map: map,
                optimized: false,
                position: latLng,
                title: "activeRoom",
                visible: true
            });
        }
        else if(searchRoomMarker != undefined){
            searchRoomMarker.setMap(map);
        }
    }
    
    function hideOverlay(){
        if(searchRoomMarker != undefined) searchRoomMarker.setMap(null);
    }

    function reset(){
        hideOverlay();
        $("#down").attr("effect","none");
        $("#up").attr("effect","none");
        searchRoomMarker = undefined;
        searchFloor = undefined;
        searchRoom = undefined;
    }
        